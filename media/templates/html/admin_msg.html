<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Messaging System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .user-panel {
      width: 350px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }
    
    .user-panel-header {
      padding: 20px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.5px;
    }
    
    .search-container {
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid transparent;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .search-input:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
    }
    
    .user-list-container {
      flex: 1;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .user-list {
      list-style: none;
    }
    
    .user-item {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .user-item:hover {
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
    }
    
    .user-item.active {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      transform: translateX(0);
    }
    
    .user-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .user-email {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .user-phone {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
    }
    
    .unread-badge {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: #ff4757;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      padding: 0 6px;
    }
    
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    
    .chat-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-user-info h3 {
      font-size: 18px;
      margin-bottom: 4px;
    }
    
    .chat-user-info span {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .status-online { background: #2ecc71; }
    .status-offline { background: #95a5a6; }
    
    .mobile-toggle {
      display: none;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .message-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(247, 250, 252, 0.9) 100%);
    }
    
    .message-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message-item {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
      animation: messageSlide 0.3s ease;
      word-wrap: break-word;
    }
    
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-item.you {
      align-self: flex-end;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }
    
    .message-item.them {
      align-self: flex-start;
      background: white;
      color: #333;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-bottom-left-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .message-content {
      margin-bottom: 4px;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.6;
    }
    
    .message-status {
      font-size: 11px;
      opacity: 0.6;
      margin-left: 5px;
    }
    
    .input-area {
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid transparent;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      resize: none;
      max-height: 100px;
      min-height: 44px;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .message-input:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.2);
    }
    
    .send-button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }
    
    .send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }
    
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-top: 2px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #ff4757;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    
    .success-message {
      background: #2ecc71;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    
    .typing-indicator {
      font-style: italic;
      color: #666;
      font-size: 12px;
      padding: 8px 16px;
    }
    
    @media (max-width: 768px) {
      body {
        background: #f8f9fa;
      }
      
      .container {
        border-radius: 0;
        background: white;
      }
      
      .user-panel {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1000;
        transform: translateX(-100%);
        width: 300px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      
      .user-panel.show {
        transform: translateX(0);
      }
      
      .mobile-toggle {
        display: block;
      }
      
      .chat-panel {
        width: 100%;
      }
      
      .message-item {
        max-width: 85%;
      }
      
      .input-area {
        padding: 15px;
      }
      
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      
      .overlay.show {
        display: block;
      }
    }
    
    @media (max-width: 480px) {
      .user-panel {
        width: 280px;
      }
      
      .chat-header {
        padding: 15px;
      }
      
      .message-area {
        padding: 15px;
      }
      
      .input-area {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  <div class="container">
    <div class="user-panel" id="userPanel">
      <div class="user-panel-header">
        Admin Dashboard
      </div>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by name, email, phone, UID..." />
      </div>
      <div class="user-list-container">
        <ul id="userList" class="user-list">
          <li class="loading">
            <div class="spinner"></div>
            Connecting to Firebase...
          </li>
        </ul>
      </div>
    </div>
    
    <div class="chat-panel">
      <div class="chat-header">
        <button class="mobile-toggle" id="mobileToggle">☰ Users</button>
        <div class="chat-user-info" id="chatUserInfo">
          <div class="empty-state">
            <div class="empty-state-icon">💬</div>
            <h3>Select a user to start messaging</h3>
            <span>Choose from the user list to begin conversation</span>
          </div>
        </div>
      </div>
      
      <div class="message-area" id="messageArea">
        <ul id="messageList" class="message-list"></ul>
      </div>
      
      <div class="input-area">
        <textarea 
          id="messageInput" 
          class="message-input" 
          placeholder="Type your message..."
          rows="1"
          disabled
        ></textarea>
        <button id="sendButton" class="send-button" disabled>Send</button>
      </div>
    </div>
  </div>

 <script>
    // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyD14wwgcUIyiPl_qXvx7CtQTO2DEy465II",
  authDomain: "my-video-earn-app12.firebaseapp.com",
  databaseURL: "https://my-video-earn-app12-default-rtdb.firebaseio.com",
  projectId: "my-video-earn-app12",
  storageBucket: "my-video-earn-app12.firebasestorage.app",
  messagingSenderId: "967539655660",
  appId: "1:967539655660:web:95e773e701d35a252936c9",
  measurementId: "G-DPWBZT3RN5"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Global variables
    let userList = [];
    let filteredUsers = [];
    let selectedUserId = null;
    let selectedUser = null;
    let messageListeners = new Map();
    let userListeners = new Map();

    // DOM elements
    const userListEl = document.getElementById('userList');
    const messageListEl = document.getElementById('messageList');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const searchInput = document.getElementById('searchInput');
    const chatUserInfo = document.getElementById('chatUserInfo');
    const messageArea = document.getElementById('messageArea');
    const mobileToggle = document.getElementById('mobileToggle');
    const userPanel = document.getElementById('userPanel');
    const overlay = document.getElementById('overlay');

    function renderErrorState() {
      userListEl.innerHTML = '<li style="padding: 20px; color: #ff4757; text-align: center;">Unable to connect to Firebase. Please check configuration.</li>';
      messageListEl.innerHTML = '<li style="padding: 20px; color: #ff4757; text-align: center;">Chat unavailable due to configuration error.</li>';
      messageInput.disabled = true;
      sendButton.disabled = true;
    }

    function init() {
      if (!db) {
        showError("Database not initialized. Please check Firebase configuration.");
        renderErrorState();
        return;
      }
      
      setupEventListeners();
      loadUsers();
    }

    function setupEventListeners() {
      searchInput.addEventListener('input', handleSearch);
      messageInput.addEventListener('input', handleMessageInput);
      messageInput.addEventListener('keypress', handleKeyPress);
      sendButton.addEventListener('click', sendMessage);
      mobileToggle.addEventListener('click', toggleUserPanel);
      overlay.addEventListener('click', hideUserPanel);
      
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          hideUserPanel();
        }
      });

      window.addEventListener('beforeunload', cleanup);
    }

    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      if (!query) {
        filteredUsers = [...userList];
      } else {
        filteredUsers = userList.filter(user =>
          (user.uid && user.uid.toLowerCase().includes(query)) ||
          (user.name && user.name.toLowerCase().includes(query)) ||
          (user.email && user.email.toLowerCase().includes(query)) ||
          (user.phone && user.phone.toLowerCase().includes(query))
        );
      }
      renderUserList();
    }

    function handleMessageInput() {
      const hasText = messageInput.value.trim().length > 0;
      sendButton.disabled = !hasText || !selectedUserId;
    }

    function handleKeyPress(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendButton.disabled) {
          sendMessage();
        }
      }
    }

    function toggleUserPanel() {
      userPanel.classList.toggle('show');
      overlay.classList.toggle('show');
    }

    function hideUserPanel() {
      userPanel.classList.remove('show');
      overlay.classList.remove('show');
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      document.body.insertBefore(errorDiv, document.body.firstChild);
      
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv);
        }
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      document.body.insertBefore(successDiv, document.body.firstChild);
      
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.parentNode.removeChild(successDiv);
        }
      }, 3000);
    }

    function loadUsers() {
      try {
        const usersRef = db.ref('users');
        const unsubscribe = usersRef.on('value', (snapshot) => {
          userList = [];
          
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const uid = childSnapshot.key;
              const userData = childSnapshot.val();
              
              userList.push({
                uid: uid,
                name: userData.name || 'Unknown User',
                email: userData.email || '',
                phone: userData.phone || '',
                lastSeen: userData.lastSeen || null,
                isOnline: userData.isOnline || false,
                unreadCount: 0
              });
            });
            
            loadUnreadCounts();
          }
          
          filteredUsers = [...userList];
          renderUserList();
        }, (error) => {
          console.error("Error loading users:", error);
          showError("Failed to load users from database. Check database permissions or network.");
          userListEl.innerHTML = '<li style="padding: 20px; color: #ff4757;">Failed to load users</li>';
        });

        userListeners.set('users', unsubscribe);
      } catch (error) {
        console.error("Error setting up users listener:", error);
        showError("Failed to connect to user database.");
      }
    }

    function loadUnreadCounts() {
      userList.forEach(user => {
        const adminInboxRef = db.ref(`adminInbox/${user.uid}`);
        const unsubscribe = adminInboxRef.on('value', (snapshot) => {
          let unreadCount = 0;
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const message = childSnapshot.val();
              if (message.from === user.uid && !message.seen) {
                unreadCount++;
              }
            });
          }
          
          const userIndex = userList.findIndex(u => u.uid === user.uid);
          if (userIndex !== -1) {
            userList[userIndex].unreadCount = unreadCount;
            
            const filteredIndex = filteredUsers.findIndex(u => u.uid === user.uid);
            if (filteredIndex !== -1) {
              filteredUsers[filteredIndex].unreadCount = unreadCount;
            }
            
            renderUserList();
          }
        }, (error) => {
          console.error(`Error loading unread counts for ${user.uid}:`, error);
        });

        userListeners.set(`unread_${user.uid}`, unsubscribe);
      });
    }

    function renderUserList() {
      if (!userList.length) {
        userListEl.innerHTML = '<li class="loading"><div class="spinner"></div>Loading users...</li>';
        return;
      }

      userListEl.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No users found</div>';
        userListEl.appendChild(li);
        return;
      }

      filteredUsers.sort((a, b) => {
        if (a.unreadCount !== b.unreadCount) {
          return b.unreadCount - a.unreadCount;
        }
        return (b.lastSeen || 0) - (a.lastSeen || 0);
      });

      filteredUsers.forEach(user => {
        const li = document.createElement('li');
        li.className = `user-item ${selectedUserId === user.uid ? 'active' : ''}`;
        
        const lastSeenText = user.lastSeen ? 
          new Date(user.lastSeen).toLocaleDateString() : 'Never';
        
        li.innerHTML = `
          <div class="user-name">${escapeHtml(user.name)}</div>
          <div class="user-email">${escapeHtml(user.email)}</div>
          ${user.phone ? `<div class="user-phone">${escapeHtml(user.phone)}</div>` : ''}
          <div class="status-indicator">
            <div class="status-dot ${user.isOnline ? 'status-online' : 'status-offline'}"></div>
            ${user.isOnline ? 'Online' : `Last seen: ${lastSeenText}`}
          </div>
          ${user.unreadCount > 0 ? `<div class="unread-badge">${user.unreadCount}</div>` : ''}
        `;
        
        li.onclick = () => selectUser(user);
        userListEl.appendChild(li);
      });
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function selectUser(user) {
      if (selectedUserId && messageListeners.has(selectedUserId)) {
        messageListeners.get(selectedUserId)();
        messageListeners.delete(selectedUserId);
      }

      selectedUserId = user.uid;
      selectedUser = user;
      
      renderUserList();
      updateChatHeader();
      loadConversation(user.uid);
      
      messageInput.disabled = false;
      messageInput.placeholder = `Message ${escapeHtml(user.name)}...`;
      handleMessageInput();
      
      if (window.innerWidth <= 768) {
        hideUserPanel();
      }
      
      markMessagesAsSeen(user.uid);
    }

    function updateChatHeader() {
      if (!selectedUser) return;
      
      const statusText = selectedUser.isOnline ? 'Online' : 
        (selectedUser.lastSeen ? `Last seen ${new Date(selectedUser.lastSeen).toLocaleString()}` : 'Offline');
      
      chatUserInfo.innerHTML = `
        <div>
          <h3>${escapeHtml(selectedUser.name)}</h3>
          <div class="status-indicator">
            <div class="status-dot ${selectedUser.isOnline ? 'status-online' : 'status-offline'}"></div>
            ${statusText}
          </div>
        </div>
      `;
    }

    function loadConversation(uid) {
      messageListEl.innerHTML = '<li class="loading"><div class="spinner"></div>Loading messages...</li>';
      
      try {
        const adminInboxRef = db.ref(`adminInbox/${uid}`);
        const userInboxRef = db.ref(`users/${uid}/inbox`);
        
        const messages = [];
        let loadedCount = 0;
        
        const checkComplete = () => {
          loadedCount++;
          if (loadedCount === 2) {
            messages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages(messages);
            scrollToBottom();
          }
        };

        adminInboxRef.once('value').then((snapshot) => {
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const message = childSnapshot.val();
              if (message.from === uid || message.to === uid) {
                messages.push({
                  ...message,
                  id: childSnapshot.key,
                  isFromUser: message.from === uid
                });
              }
            });
          }
          checkComplete();
        }).catch((error) => {
          console.error("Error loading admin inbox:", error);
          showError("Failed to load admin messages.");
          checkComplete();
        });

        userInboxRef.once('value').then((snapshot) => {
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const message = childSnapshot.val();
              if (message.from === 'admin' || message.to === uid) {
                messages.push({
                  ...message,
                  id: childSnapshot.key,
                  isFromUser: false
                });
              }
            });
          }
          checkComplete();
        }).catch((error) => {
          console.error("Error loading user inbox:", error);
          showError("Failed to load user messages.");
          checkComplete();
        });

        const adminListener = adminInboxRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            const latestMessages = [];
            snapshot.forEach((childSnapshot) => {
              const message = childSnapshot.val();
              if (message.from === uid && message.timestamp > Date.now() - 5000) {
                latestMessages.push({
                  ...message,
                  id: childSnapshot.key,
                  isFromUser: true
                });
              }
            });
            
            if (latestMessages.length > 0) {
              latestMessages.forEach(msg => addMessageToUI(msg));
              scrollToBottom();
              markMessagesAsSeen(uid);
            }
          }
        }, (error) => {
          console.error("Error in admin inbox listener:", error);
          showError("Failed to receive real-time messages.");
        });

        messageListeners.set(uid, () => {
          adminInboxRef.off('value', adminListener);
        });

      } catch (error) {
        console.error("Error loading conversation:", error);
        messageListEl.innerHTML = '<li style="padding: 20px; color: #ff4757; text-align: center;">Failed to load messages</li>';
      }
    }

    function renderMessages(messages) {
      messageListEl.innerHTML = '';
      
      if (messages.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No messages yet. Start the conversation!</div>';
        messageListEl.appendChild(li);
        return;
      }

      messages.forEach(message => {
        addMessageToUI(message);
      });
    }

    function addMessageToUI(message) {
      if (document.querySelector(`[data-message-id="${message.id}"]`)) {
        return;
      }

      const li = document.createElement('li');
      const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const isFromUser = message.isFromUser;
      
      li.className = `message-item ${isFromUser ? 'them' : 'you'}`;
      li.setAttribute('data-message-id', message.id);
      
      const statusIcon = !isFromUser ? (message.seen ? '✓✓' : '✓') : '';
      
      li.innerHTML = `
        <div class="message-content">${escapeHtml(message.message)}</div>
        <div class="message-time">
          ${time}
          ${statusIcon ? `<span class="message-status">${statusIcon}</span>` : ''}
        </div>
      `;
      
      messageListEl.appendChild(li);
    }

    function scrollToBottom() {
      messageArea.scrollTop = messageArea.scrollHeight;
    }

    async function sendMessage() {
      if (!selectedUserId || !messageInput.value.trim()) return;

      const messageText = messageInput.value.trim();
      const message = {
        from: 'admin',
        to: selectedUserId,
        message: messageText,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        seen: false
      };

      try {
        const userInboxRef = db.ref(`users/${selectedUserId}/inbox`);
        const newMessageRef = userInboxRef.push();
        
        await newMessageRef.set(message);
        
        addMessageToUI({
          ...message,
          id: newMessageRef.key,
          isFromUser: false,
          timestamp: Date.now()
        });
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendButton.disabled = true;
        scrollToBottom();
        showSuccess('Message sent successfully');
      } catch (error) {
        console.error("Error sending message:", error);
        showError("Failed to send message. Please try again.");
      }
    }

    async function markMessagesAsSeen(uid) {
      try {
        const adminInboxRef = db.ref(`adminInbox/${uid}`);
        const snapshot = await adminInboxRef.once('value');
        
        if (snapshot.exists()) {
          const updates = {};
          snapshot.forEach((childSnapshot) => {
            const message = childSnapshot.val();
            if (message.from === uid && !message.seen) {
              updates[`${childSnapshot.key}/seen`] = true;
            }
          });
          
          if (Object.keys(updates).length > 0) {
            await adminInboxRef.update(updates);
            
            const userIndex = userList.findIndex(u => u.uid === uid);
            if (userIndex !== -1) {
              userList[userIndex].unreadCount = 0;
              const filteredIndex = filteredUsers.findIndex(u => u.uid === uid);
              if (filteredIndex !== -1) {
                filteredUsers[filteredIndex].unreadCount = 0;
              }
              renderUserList();
            }
          }
        }
      } catch (error) {
        console.error("Error marking messages as seen:", error);
        showError("Failed to update message status.");
      }
    }

    function cleanup() {
      messageListeners.forEach((unsubscribe) => unsubscribe());
      userListeners.forEach((unsubscribe) => unsubscribe());
      messageListeners.clear();
      userListeners.clear();
    }

    // Start the application
    init();
  </script>
</body>
</html>